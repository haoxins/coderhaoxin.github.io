---
title: 数据库系统内幕
description: 少焉, 月出于东山之上, 徘徊于斗牛之间. 白露横江, 水光接天.
date: 2022-03-11
---

* [数据库系统内幕](https://book.douban.com/subject/35078474/)
  - 作为**微信读书**付费会员, 为微信读书的`时效性`提升点赞

---

## 存储引擎简介

* **空间局部性**原则是**局部性原则**之一. 该原则指出,
  如果访问一处存储, 则其附近的其他存储区域也会在不久的将来被访问.

* 认为`行存储`和`列存储`之间的区别仅在于数据的存储方式有所不同, 这是不充分的.
  选择数据布局只是列式存储所针对的一系列可能的优化的步骤之一.
  - 在一次读取中, 从同一列中读取多个值可以显著提高缓存利用率和计算效率.
    在现代 `CPU` 上, 向量化指令可以使单条 `CPU` 指令一次处理多个数据点.
  - 另外, 将具有相同数据类型的值存储在一起可以提高压缩率.
    我们可以根据不同的数据类型使用不同的压缩算法,
    并为每种情况选择最有效的压缩方法.

* 面向列的数据库不应与宽列式存储 (如 `BigTable` 或 `HBase`) 相混淆.
  在这些数据库中, 数据表示为多维映射, 列被分组为列族 (通常存储相同类型的数据),
  并且在每个列族中, 数据被逐行存储.
  - 此布局最适合存储由一个键或一组键来检索的数据.

* 索引文件的大小通常比数据文件小. 文件被划分成页 (`page`),
  每个页通常具有单个或多个磁盘块的大小.
  - 页可以被组织成记录的序列或分槽页 (`slotted page`) .
* 新增记录 (插入) 和对现有记录的更新使用`键/值`对来表示.
  大多数现代存储系统不显式地删除页上的数据.
* 相反, 它们使用删除标记 (`deletion marker`, 也称为墓碑 (`tombstone`)),
  其中包含此删除动作的元数据, 如键和时间戳. 在垃圾收集过程中,
  这些被更新或被删除标记遮盖 (`shadowed`) 过的记录所占用的空间会被数据库回收.
  该过程会读取页, 然后将活动 (即未被遮盖) 的记录写入新位置, 并丢弃被遮盖的记录.

* 主 (数据) 文件上的索引称为主索引. 但是, 在大多数情况下,
  我们还可以假设主索引是在主键或作为主键的一组键之上构建的.
  所有其他索引都称为二级索引 (`secondary index`).
* 二级索引可以直接指向数据记录, 也可以简单地存储它的主键.
  指向数据记录的指针可以保存堆文件或索引组织表中的偏移量.

* 如果数据记录的顺序遵循搜索键顺序, 则这种索引称为聚簇索引
  (`clustered/clustering index`).
  聚簇索引中的数据记录通常与索引存储于同一文件,
  有时也存放在单独的聚簇文件中, 而这些文件均保留了键的顺序.
* 如果数据存储在单独的文件中, 且其顺序不遵循键顺序,
  则索引称为非聚簇索引 (`nonclustered/unclustered index`) .

* 索引组织表以索引的顺序保存数据, 因此按定义一定是聚簇的.
  主索引通常是聚簇的, 而根据定义, 二级索引一定不是聚簇的,
  因为它们是用于加速主键以外的键的访问的.
  - 聚簇索引既可以是索引组织的,
    也可以具有单独的索引和数据文件.

* 如果工作负载主要由读操作组成, 那么更新几个索引可能没有什么问题,
  但是对于具有多个索引, 以写为主的工作负载, 这种方法便不能很好地工作了.
* 为了减少指针更新的成本, 一些数据库的具体实现是使用主键进行间接操作,
  而不是直接使用数据偏移量.

* 通常, `LSM`树和`B`树之间的区别便是数据是不可变的还是原地更新的,
  但是也存在受`B`树启发但不可变的数据结构.

## B树基础知识

* 在深入研究`B`树之前, 让我们先讨论一下为什么应该考虑替代传统搜索树
  (例如, 二分搜索树, `2-3`树和`AVL`树).

* 一棵**二分搜索树**中只能有一个根节点.
* 每个节点将搜索空间分为左子树和右子树:
  - 一个节点的键大于其左子树中存储的任何键,
  - 且小于其右子树中存储的任何键.
* 插入操作并不会遵循任何特定模式, 元素插入可能导致树不平衡的情况
  (即它的一个分支比另一个分支长). 最差的情况得到一棵病态树, 更像一个链表,
  此时我们得到的不是期望的对数时间复杂度, 而是线性时间复杂度.

* 平衡树指的是高度为
  $$ log2{N} $$
  的树 (其中 `N` 是树中数据项的总数),
  并且两个子树之间的高度差不大于 `1`.

* 树的平衡是通过以最小化树高并将每一边的节点数
  保持在界限内的方式重新组织节点来完成的.
* 保持树的平衡的方法之一是在添加或删除节点后执行旋转:
  如果插入操作使分支不平衡 (分支中的两个连续节点只有一个子节点),
  则可以围绕中间节点旋转树.

* 由于扇出较低 (扇出是指每个节点允许拥有的最大子节点数),
  我们必须相当频繁地执行平衡操作, 重新定位节点并更新指针.
  维护成本的增加使得二分搜索树作为存储在磁盘上的数据结构变得不切实际.

* 适合磁盘实现的树必须具有以下属性:
  - 高扇出, 以改善邻近键的数据局部性.
  - 低高度, 以减少遍历期间的寻道次数.

* 典型的 `SSD` 由记忆单元构成, 这些单元连接成串
  (每个串通常为 `32` 到 `64` 个单元),
  串被组合成阵列, 阵列被组合成页, 页被组合成块.
* 可写 (可编程) 或可读的最小单元是页. 但是, 我们只能对空的记忆单元进行更改
  (即, 对写入之前已擦除的单元进行更改).
* 最小的擦除实体不是页, 而是保存多个页的块, 这就是为什么它通常被称为擦除块.
  空块中的页必须按顺序写入.
* 每当我们从块设备读取单个字时, 包含它的整个块将会被读取.
  这是我们不能忽视的一个限制, 在处理基于磁盘存储的数据结构时应该始终考虑到这一点.

* 每当我们从块设备读取单个字时, 包含它的整个块将会被读取.
  这是我们不能忽视的一个限制,
  在处理基于磁盘存储的数据结构时应该始终考虑到这一点.

---

* `B`树是有序的: `B`树节点内的键按顺序存储. 因此,
  我们可以使用像二分搜索这样的算法来定位搜索到的键.
  这也意味着`B`树中的查找具有对数复杂度.
* 使用`B`树, 我们可以有效地执行单点查询和范围查询.
  在大多数查询语言中, 我们通过谓词相等 `(=)`
  表示单点查询来定位单个项, 而通过谓词比较
  `(<, >, ≤ 和 ≥)`
  表示范围查询来按顺序查询多个数据项.

* `B`树由多个节点组成. 每个节点最多可容纳`N`个键和`N+1`个指向子节点的指针.
  这些节点在逻辑上分为三类.
  - **根节点**: 根节点没有父节点, 是树的顶端.
  - **叶节点**: 叶节点是没有子节点的底层节点.
  - **内部节点**: 连接根节点和叶节点的其他节点,
    `B`树通常包含多层的内部节点.

* 由于`B`树是一种页组织技术 (即用于组织和导航固定大小的页的技术),
  所以节点和页这两个术语在描述中可相互替换.
* 节点容量与其实际持有的键的个数之间的关系称为占用率.
* `B`树的特征在于其扇出 (fanout):
  存储在每个节点中的键的个数. 为保持树的平衡需要做出一些结构上的更改,
  而更高的扇出则有助于均摊这些更改的所带来的开销.
* 同时, 通过在单个块或多个连续块中存储指向子节点的键和指针,
  可以减少寻道的次数.

* `B`树允许在根节点, 内部节点和叶节点当中的任意层上储存值.
  而`B+`树则仅在叶节点中存储值, 其内部节点仅存储分隔键,
  用于指引搜索算法去找到叶节点上的关联值.

* `B+`树广为人知, 因此我们像其他文献中一样称之为`B`树.

* 存储在`B`树节点中的键称为索引条目 (`index entry`),
  分隔键 (`separator key`) 或分隔符单元格 (`divider cell`).
* 它将树分割成子树 (也称为分支或子范围), 其持有包含对应键的范围.
  键存储时已经排好序, 以便使用二分搜索.
* 查找算法通过定位一个键并跟随相应的指针从较高的层次移动到较低的层次来找到一个子树.

## 文件格式

## B树的实现

## 事务处理与恢复

## B树的变体

## 日志结构存储

## 分布式系统简介

## 故障检测

## 领导者选举

## 复制和一致性

## 反熵和传播

## 分布式事务

## 共识
