---
title: 数据库系统内幕
description: 少焉, 月出于东山之上, 徘徊于斗牛之间. 白露横江, 水光接天.
date: 2022-03-11
---

* [数据库系统内幕](https://book.douban.com/subject/35078474/)
  - 作为**微信读书**付费会员, 为微信读书的`时效性`提升点赞

---

## 存储引擎简介

* **空间局部性**原则是**局部性原则**之一. 该原则指出,
  如果访问一处存储, 则其附近的其他存储区域也会在不久的将来被访问.

* 认为`行存储`和`列存储`之间的区别仅在于数据的存储方式有所不同, 这是不充分的.
  选择数据布局只是列式存储所针对的一系列可能的优化的步骤之一.
  - 在一次读取中, 从同一列中读取多个值可以显著提高缓存利用率和计算效率.
    在现代 `CPU` 上, 向量化指令可以使单条 `CPU` 指令一次处理多个数据点.
  - 另外, 将具有相同数据类型的值存储在一起可以提高压缩率.
    我们可以根据不同的数据类型使用不同的压缩算法,
    并为每种情况选择最有效的压缩方法.

* 面向列的数据库不应与宽列式存储 (如 `BigTable` 或 `HBase`) 相混淆.
  在这些数据库中, 数据表示为多维映射, 列被分组为列族 (通常存储相同类型的数据),
  并且在每个列族中, 数据被逐行存储.
  - 此布局最适合存储由一个键或一组键来检索的数据.

* 索引文件的大小通常比数据文件小. 文件被划分成页 (`page`),
  每个页通常具有单个或多个磁盘块的大小.
  - 页可以被组织成记录的序列或分槽页 (`slotted page`) .
* 新增记录 (插入) 和对现有记录的更新使用`键/值`对来表示.
  大多数现代存储系统不显式地删除页上的数据.
* 相反, 它们使用删除标记 (`deletion marker`, 也称为墓碑 (`tombstone`)),
  其中包含此删除动作的元数据, 如键和时间戳. 在垃圾收集过程中,
  这些被更新或被删除标记遮盖 (`shadowed`) 过的记录所占用的空间会被数据库回收.
  该过程会读取页, 然后将活动 (即未被遮盖) 的记录写入新位置, 并丢弃被遮盖的记录.

* 主 (数据) 文件上的索引称为主索引. 但是, 在大多数情况下,
  我们还可以假设主索引是在主键或作为主键的一组键之上构建的.
  所有其他索引都称为二级索引 (`secondary index`).
* 二级索引可以直接指向数据记录, 也可以简单地存储它的主键.
  指向数据记录的指针可以保存堆文件或索引组织表中的偏移量.

* 如果数据记录的顺序遵循搜索键顺序, 则这种索引称为聚簇索引
  (`clustered/clustering index`).
  聚簇索引中的数据记录通常与索引存储于同一文件,
  有时也存放在单独的聚簇文件中, 而这些文件均保留了键的顺序.
* 如果数据存储在单独的文件中, 且其顺序不遵循键顺序,
  则索引称为非聚簇索引 (`nonclustered/unclustered index`) .

* 索引组织表以索引的顺序保存数据, 因此按定义一定是聚簇的.
  主索引通常是聚簇的, 而根据定义, 二级索引一定不是聚簇的,
  因为它们是用于加速主键以外的键的访问的.
  - 聚簇索引既可以是索引组织的,
    也可以具有单独的索引和数据文件.

* 如果工作负载主要由读操作组成, 那么更新几个索引可能没有什么问题,
  但是对于具有多个索引, 以写为主的工作负载, 这种方法便不能很好地工作了.
* 为了减少指针更新的成本, 一些数据库的具体实现是使用主键进行间接操作,
  而不是直接使用数据偏移量.

* 通常, `LSM`树和`B`树之间的区别便是数据是不可变的还是原地更新的,
  但是也存在受`B`树启发但不可变的数据结构.

## B树基础知识

* 在深入研究`B`树之前, 让我们先讨论一下为什么应该考虑替代传统搜索树
  (例如, 二分搜索树, `2-3`树和`AVL`树).

* 一棵**二分搜索树**中只能有一个根节点.
* 每个节点将搜索空间分为左子树和右子树:
  - 一个节点的键大于其左子树中存储的任何键,
  - 且小于其右子树中存储的任何键.
* 插入操作并不会遵循任何特定模式, 元素插入可能导致树不平衡的情况
  (即它的一个分支比另一个分支长). 最差的情况得到一棵病态树, 更像一个链表,
  此时我们得到的不是期望的对数时间复杂度, 而是线性时间复杂度.

## 文件格式

## B树的实现

## 事务处理与恢复

## B树的变体

## 日志结构存储

## 分布式系统简介

## 故障检测

## 领导者选举

## 复制和一致性

## 反熵和传播

## 分布式事务

## 共识
